name: Pull Request Checks

on:
    pull_request:
        branches: [master]

jobs:
    lint:
        name: Lint Code
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: ".nvmrc"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Check code formatting
              run: npm run format -- --check

    unit-tests:
        name: Unit Tests
        needs: lint
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: ".nvmrc"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run unit tests with coverage
              run: npm run test:coverage

            - name: Upload unit test coverage
              uses: actions/upload-artifact@v5
              if: always()
              with:
                  name: unit-test-coverage
                  path: coverage/
                  retention-days: 7

    e2e-tests:
        name: E2E Tests
        needs: lint
        runs-on: ubuntu-latest
        environment: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: ".nvmrc"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright Browsers
              run: npx playwright install --with-deps chromium

            - name: Run E2E tests
              run: npm run test:e2e
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
                  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
                  E2E_USERNAME_ID: ${{ secrets.E2E_USERNAME_ID }}
                  E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
                  E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}

            - name: Upload E2E test report
              uses: actions/upload-artifact@v5
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 7

    status-comment:
        name: PR Status Comment
        needs: [lint, unit-tests, e2e-tests]
        runs-on: ubuntu-latest
        if: always()
        permissions:
            pull-requests: write

        steps:
            - name: Download unit test coverage
              uses: actions/download-artifact@v6
              continue-on-error: true
              with:
                  name: unit-test-coverage
                  path: ./coverage

            - name: Download E2E test report
              uses: actions/download-artifact@v6
              continue-on-error: true
              with:
                  name: playwright-report
                  path: ./playwright-report

            - name: Check job results
              id: check_results
              run: |
                  LINT_STATUS="${{ needs.lint.result }}"
                  UNIT_STATUS="${{ needs.unit-tests.result }}"
                  E2E_STATUS="${{ needs.e2e-tests.result }}"

                  echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
                  echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
                  echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT

                  if [ "$LINT_STATUS" == "success" ] && [ "$UNIT_STATUS" == "success" ] && [ "$E2E_STATUS" == "success" ]; then
                    echo "overall_status=✅ All checks passed" >> $GITHUB_OUTPUT
                    echo "overall_emoji=✅" >> $GITHUB_OUTPUT
                  else
                    echo "overall_status=❌ Some checks failed" >> $GITHUB_OUTPUT
                    echo "overall_emoji=❌" >> $GITHUB_OUTPUT
                  fi

            - name: Comment PR
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const lintStatus = '${{ steps.check_results.outputs.lint_status }}';
                      const unitStatus = '${{ steps.check_results.outputs.unit_status }}';
                      const e2eStatus = '${{ steps.check_results.outputs.e2e_status }}';
                      const overallStatus = '${{ steps.check_results.outputs.overall_status }}';

                      const getEmoji = (status) => {
                        if (status === 'success') return '✅';
                        if (status === 'failure') return '❌';
                        if (status === 'cancelled') return '⏸️';
                        return '⚠️';
                      };

                      const comment = `## ${{ steps.check_results.outputs.overall_emoji }} Pull Request Checks

                      | Check | Status |
                      |-------|--------|
                      | Lint | ${getEmoji(lintStatus)} ${lintStatus} |
                      | Unit Tests | ${getEmoji(unitStatus)} ${unitStatus} |
                      | E2E Tests | ${getEmoji(e2eStatus)} ${e2eStatus} |

                      **Overall Status:** ${overallStatus}

                      ---
                      *Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
